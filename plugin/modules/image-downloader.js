var q=Symbol("delay");function L(e){return new Promise(t=>setTimeout(()=>t(q),e))}async function _(e,t,{delayMS:n=500,batchSize:o=5}={}){let a=[];for(let r=0;r<e.length;r+=o){let i=e.slice(r,r+o),s=await Promise.allSettled(i.map((c,l,m)=>t(c,r+l,m)));a.push(...s),r+o<e.length&&await L(n);}return a}function g(e){return e!=null}function d(e){return e==null}function f(e){return typeof e=="string"&&e.trim()!==""}function y(e){try{return new URL(e,window.location.href).href}catch{return e}}function J(e,t){return e.complete&&e.naturalWidth!==0?Promise.resolve():new Promise((n,o)=>{let a=g(t)&&typeof t=="number"&&t>0,r=()=>{s(),n();},i=m=>{s(),o(m||new Error("Image failed to load"));},s=()=>{l&&clearTimeout(l),e.removeEventListener("load",r),e.removeEventListener("error",i);},c=a?()=>{s(),o(`Image failed to load before the timeout of ${t}ms`);}:()=>{};e.addEventListener("load",r,{once:true}),e.addEventListener("error",i,{once:true});let l=a&&setTimeout(c,t)||void 0;})}function Q(e){return e.crossOrigin="anonymous",e.loading="eager",e.referrerPolicy="no-referrer",e}async function u(e,t){let n=Q(new Image);return n.src=e,await J(n,t),n}function p(e,t){return new Promise((n,o)=>{try{e.toBlob(a=>g(a)?n(a):o(new Error("Canvas toBlob returned null")),t||void 0);}catch(a){o(a);}})}async function A(e,t){if(!t)return e;try{let n=document.createElement("canvas"),o=!1,a=await createImageBitmap(e);n.width=a.width,n.height=a.height;let r=n.getContext("2d");if(r&&(r.drawImage(a,0,0),o=!0),a.close(),!o){let s=document.createElement("img"),c=URL.createObjectURL(e);await new Promise((m,O)=>{s.onload=m,s.onerror=O,s.src=c;}),n.width=s.naturalWidth,n.height=s.naturalHeight;let l=n.getContext("2d");if(!l)return e;l.drawImage(s,0,0),URL.revokeObjectURL(c);}return await p(n,t)||e}catch{return e}}function P(e,t){t=g(t)?t:document.createElement("canvas"),t.width=e.naturalWidth,t.height=e.naturalHeight;let n=t.getContext("2d");if(n)return n.drawImage(e,0,0),t}function R(e,t){let n=URL.createObjectURL(e),o=document.createElement("a");o.href=n,o.download=t||"download",document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n);}var w="<img>";var I="<svg>",b="<canvas>",C="unknown",h={"image/jpeg":"jpg","image/jpg":"jpg","image/png":"png","image/gif":"gif","image/webp":"webp","image/apng":"apng","image/avif":"avif","image/svg+xml":"svg","image/bmp":"bmp","image/x-icon":"ico","image/vnd.microsoft.icon":"ico"},G={jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",webp:"image/webp",apng:"image/apng",avif:"image/avif",svg:"image/svg+xml",bmp:"image/bmp",ico:"image/x-icon"},B=new Set(["webp","avif","jpg"]),U=new Set(["jpg","jpeg","png","gif","webp","apng","avif","svg","bmp","ico"]),F=new Set(["jpg","jpeg","png","bmp","ico"]),M=["webp","gif","apng","avif"],k=["format","fm","type","imageformat","ext"];function N(e,t){if(typeof e=="string")return {filename:e};if(!e||typeof e!="object")return {};let n=e.filename;if(typeof n=="function")try{n=n(t,e.params);}catch{n=void 0;}let o=typeof n=="string",a="convert"in e&&oe(e.convert)||"convertMime"in e&&e.convertMime||void 0,r="downloadTimeoutMS"in e?e.downloadTimeoutMS:5e3;return {...o&&{filename:n},...e.preferNetwork===true&&{preferNetwork:true},...e.preferCanvas===true&&{preferCanvas:true},...a&&{convertMime:a},...e.params&&{params:e.params},downloadTimeoutMS:r}}function H(e,t){return d(e)?g(t)?{...t}:{}:g(t)&&Object.keys(t).length>0?typeof e=="string"?{...t,filename:e}:e&&typeof e=="object"?{...t,...e}:{...t}:e}async function z(e,t,n){let o,a=async(i=false)=>{try{o=await Z(t.src,n);}catch(s){if(i)throw s;r(true);}},r=async(i=false)=>{try{let s=g(e)?e:await u(t.src);o=await ee(s,t,n);}catch(s){if(i)throw s;a(true);}};if(ae(t,n)?await a():await r(),d(o))throw "Failed to download an image";return t.name=v({...f(n.filename)&&{overrideName:n.filename},...f(t.src)&&{url:t.src},...f(o.mime)&&{mime:o.mime},defaultExt:"img",defaultBase:"image"}),E(o,t)}async function j(e,t={}){e=await Y(e,t);let{blob:n,mime:o,src:a}=e,{filename:r}=t,i=v({...f(r)&&{overrideName:r},...f(a)&&{url:a},...f(o)&&{mime:o},defaultExt:"img",defaultBase:"image"});R(n,i);}async function Z(e,t){let n;try{n=await fetch(e);}catch{throw "[getImageBlob_fetch] Network error while fetching image"}if(!n.ok)throw `[getImageBlob_fetch]: network error, status ${n.status} while fetching image`;let o=n.headers.get("Content-Type")||"",a=o.split(";")[0]?.trim().toLowerCase();if(a&&!a.startsWith("image/"))throw `[getImageBlob_fetch] fetched resource is not an image: Content-Type: ${o}`;let r=await n.blob(),i=a&&a.startsWith("image/")?a:r.type&&r.type.startsWith("image/")?r.type:void 0;if(!i||!i.startsWith("image/"))throw "[getImageBlob_fetch] fetched data is not an image (no usable image MIME type)";return Y({blob:r,mime:i},t)}async function ee(e,t,n){let o=P(e);if(d(o))throw `[getImageBlob_canvas] Failed to draw image to canvas (${t.src})`;let a=await p(o,n.convertMime??t.extension),r=a.type||n.convertMime||t.extension||"image/png";return E({blob:a,mime:r},t)}function $(e,t){let n=e.cloneNode(true);n.getAttribute("xmlns")||n.setAttribute("xmlns","http://www.w3.org/2000/svg");let a=new XMLSerializer().serializeToString(n),r="image/svg+xml",i=v({mime:r,defaultExt:"svg",defaultBase:"image"});return E({blob:new Blob([a],{type:r}),mime:r},{...t,extension:"svg",name:i})}async function V(e,t,n){let o=await p(e,n?.convertMime??t.extension),a=o.type||n?.convertMime||t.extension||"image/png";return E({blob:o,mime:a},t)}async function Y(e,t){if(d(t?.convertMime)||t.convertMime===e.mime)return e;try{return {...e,blob:await A(e.blob,t.convertMime),mime:t.convertMime}}catch(n){return console.warn(`[convertBlob] Failed to convert image from ${e.mime} to ${t.convertMime}`,n),e}}function W(e){return e instanceof HTMLImageElement?w:typeof e=="string"?"url":e instanceof HTMLCanvasElement?b:te(e)?I:C}function x(e,{filename:t}){let n=X(e);return {src:e,extension:n,mime:void 0,...t&&{name:t}}}function E(e,t){return {...g(t)&&t,...e}}function te(e){return typeof SVGSVGElement<"u"&&e instanceof SVGSVGElement||g(e)&&typeof e=="object"&&e.nodeType===1&&typeof e.tagName=="string"&&e.tagName.toLowerCase()==="svg"}function v({overrideName:e,url:t,mime:n,defaultExt:o="img",defaultBase:a="image"}){let r=n?ne(n):null,i=t?X(t):null,s=r||i||o;if(e&&typeof e=="string"){let c=e.trim();c||(c=a);let l=c.split(/[\/\\]/).pop(),m=l.lastIndexOf(".");return m>0&&m<l.length-1?l:`${l}.${s}`}if(t)try{let l=(new URL(t,window.location.href).pathname.split("/").pop()||"").split(/[?#]/)[0];if(l){let m=l.lastIndexOf(".");return m>0?`${l.slice(0,m)}.${s}`:`${l}.${s}`}}catch{}return `${a}.${s}`}function ne(e){if(e){if(e=e.toLowerCase().trim(),h[e])return h[e];if(e.startsWith("image/"))return e.slice(6)}}function X(e){try{let o=new URL(e,window.location.href).pathname.split("/").pop()||"",[a]=o.split("?"),[r]=a.split("#"),i=r.lastIndexOf(".");if(i===-1)return;let s=r.slice(i+1).toLowerCase();return /^[a-z0-9+]+$/.test(s)?s:void 0}catch{let n=e.split(/[?#]/)[0].split("/").pop()||"",o=n.lastIndexOf(".");if(o===-1)return;let a=n.slice(o+1).toLowerCase();return /^[a-z0-9+]+$/.test(a)?a:void 0}}function oe(e){if(!(!e||!B.has(e)))return e?G[e]:void 0}function ae(e,t){if(t.preferNetwork)return  true;if(t.preferCanvas)return  false;let n=e.extension&&U.has(e.extension),o=e.extension&&F.has(e.extension);return d(e.extension)||!n||re(e.src)||ie(e.src)&&!o}function re(e){return /\.(gif|apng|webp|avif)(?=($|[?#]))/i.test(e)}function ie(e){try{let t=new URL(e,window.location.href),n=t.searchParams;for(let a of k){let r=n.get(a);if(r&&M.includes(r.toLowerCase()))return !0}let o=t.search.toLowerCase();return M.some(a=>o.includes(`format=${a}`)||o.includes(`fm=${a}`))}catch{return /(format|fm)=\s*(webp|gif|apng|avif)/i.test(e)}}async function D(e,t){let n=N(t,e),o,a;switch(W(e)){case w:{o=e;let i=y(o.currentSrc??o.src);a=x(i,n);break}case "url":{let i=y(e);a=x(i,n),n.preferCanvas&&(o=await u(i,n.downloadTimeoutMS));break}case I:return $(e);case b:return await V(e,{src:"HTML5 Canvas"},n);default:throw TypeError("Unrecognized image input")}return await z(o,a,n)}async function S(e,t){let n=N(t,e),o=await D(e,n);j(o,n);}async function K(e,t={}){let{batchSize:n=5,delayMS:o=500,...a}=t??{};return e instanceof NodeList&&(e=Array.from(e)),_(e,r=>{let[i,s]=Array.isArray(r)?r:[r,void 0],c=H(s,a);return S(i,c)},{batchSize:n,delayMS:o})}window.imageToBlob=D;window.downloadImage=S;window.downloadImages=K;