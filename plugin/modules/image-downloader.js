var G=Symbol("delay");function I(e){return new Promise(n=>setTimeout(()=>n(G),e))}async function y(e,n,{delayMS:t=500,batchSize:o=5}={}){let r=[];for(let a=0;a<e.length;a+=o){let i=e.slice(a,a+o),s=await Promise.allSettled(i.map((c,l,d)=>n(c,a+l,d)));r.push(...s),a+o<e.length&&await I(t);}return r}function m(e){return e!=null}function f(e){return e==null}var g={"image/jpeg":"jpg","image/jpg":"jpg","image/png":"png","image/gif":"gif","image/webp":"webp","image/apng":"apng","image/avif":"avif","image/svg+xml":"svg","image/bmp":"bmp","image/x-icon":"ico","image/vnd.microsoft.icon":"ico"},E={jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",webp:"image/webp",apng:"image/apng",avif:"image/avif",svg:"image/svg+xml",bmp:"image/bmp",ico:"image/x-icon"},b=new Set(["webp","avif","jpg"]),N=new Set(["jpg","jpeg","png","gif","webp","apng","avif","svg","bmp","ico"]),T=new Set(["jpg","jpeg","png","bmp","ico"]),u=["webp","gif","apng","avif"],x=["format","fm","type","imageformat","ext"];async function D(e,n={}){let t=R(e.currentSrc??e.src),o=await B(t,n.downloadTimeoutMS),r=m(o)?o:$(e),a=F(t,n);return M(r,a,n)}async function L(e,n={}){let t=R(e),o=F(t,n),r={...!n.preferCanvas&&{preferNetwork:true}};return M(null,o,{...r,...n})}async function O(e,n={}){let t=e.cloneNode(true);t.getAttribute("xmlns")||t.setAttribute("xmlns","http://www.w3.org/2000/svg");let r=new XMLSerializer().serializeToString(t),a=new Blob([r],{type:"image/svg+xml"}),{filename:i}=n,s=w({overrideName:i,mime:"image/svg+xml",defaultExt:"svg",defaultBase:"image"});p(a,s);}async function S(e,n){try{return await k(e,{src:window.location.href},n)}catch(t){console.warn("[startCanvasDownload] Failed to download canvas",t);}}async function M(e,n,t){let o=false;if(j(n,t))try{return await v(n,t)}catch(a){o=true,console.warn(`[startImageDownload] Encountered an error while fetching ${n.src} via network; will attempt to download via canvas`,a);}let r=m(e)?e:await B(n.src);if(f(r))throw `[startImageDownload] Failed to load image into tag (${n.src})`;try{return await X(r,n,t)}catch(a){if(o){console.warn(`[startImageDownload] Failed to download canvas for ${n.src}`,a);return}else {console.warn(`[startImageDownload] Failed to download canvas for ${n.src}; attempting network download`,a);try{return await v(n,t)}catch(i){console.warn(`[startImageDownload] Encountered an error while fetching ${n.src} via network`,i);return}}}}function j(e,n){if(n.preferNetwork)return  true;if(n.preferCanvas)return  false;let t=e.extension&&N.has(e.extension),o=e.extension&&T.has(e.extension);return f(e.extension)||!t||J(e.src)||Q(e.src)&&!o}function R(e){try{return new URL(e,window.location.href).href}catch{return e}}function C(e){return typeof SVGSVGElement<"u"&&e instanceof SVGSVGElement||m(e)&&e.nodeType===1&&typeof e.tagName=="string"&&e.tagName.toLowerCase()==="svg"}function F(e,{filename:n}){let t=_(e);return {src:e,extension:t,mimeType:void 0,...n&&{name:n}}}function V(e,n){return e.complete&&e.naturalWidth!==0?Promise.resolve():new Promise((t,o)=>{let r=m(n)&&typeof n=="number"&&n>0,a=()=>{s(),t();},i=d=>{s(),o(d||new Error("Image failed to load"));},s=()=>{l&&clearTimeout(l),e.removeEventListener("load",a),e.removeEventListener("error",i);},c=r?()=>{s(),o(`Image failed to load before the timeout of ${n}ms`);}:()=>{};e.addEventListener("load",a,{once:true}),e.addEventListener("error",i,{once:true});let l=r&&setTimeout(c,n)||void 0;})}function U(e){if(e){if(e=e.toLowerCase().trim(),g[e])return g[e];if(e.startsWith("image/"))return e.slice(6)}}function _(e){try{let o=new URL(e,window.location.href).pathname.split("/").pop()||"",[r]=o.split("?"),[a]=r.split("#"),i=a.lastIndexOf(".");if(i===-1)return;let s=a.slice(i+1).toLowerCase();return /^[a-z0-9+]+$/.test(s)?s:void 0}catch{let t=e.split(/[?#]/)[0].split("/").pop()||"",o=t.lastIndexOf(".");if(o===-1)return;let r=t.slice(o+1).toLowerCase();return /^[a-z0-9+]+$/.test(r)?r:void 0}}function W(e){if(!(!e||!b.has(e)))return e?E[e]:void 0}function A(e,n){if(typeof e=="string")return {filename:e};if(!e||typeof e!="object")return {};let t=e.filename;if(typeof t=="function")try{t=t(n,e.params);}catch{t=void 0;}let o=typeof t=="string",r=W(e.convert);return {...o&&{filename:t},...e.preferNetwork===true&&{preferNetwork:true},...e.preferCanvas===true&&{preferCanvas:true},convertMime:r,params:e.params}}function P(e,n){return f(e)?m(n)?{...n}:{}:m(n)&&Object.keys(n).length>0?typeof e=="string"?{...n,filename:e}:e&&typeof e=="object"?{...n,...e}:{...n}:e}function w({overrideName:e,url:n,mime:t,defaultExt:o="img",defaultBase:r="image"}){let a=t?U(t):null,i=n?_(n):null,s=a||i||o;if(e&&typeof e=="string"){let c=e.trim();c||(c=r);let l=c.split(/[\/\\]/).pop(),d=l.lastIndexOf(".");return d>0&&d<l.length-1?l:`${l}.${s}`}if(n)try{let l=(new URL(n,window.location.href).pathname.split("/").pop()||"").split(/[?#]/)[0];if(l){let d=l.lastIndexOf(".");return d>0?`${l.slice(0,d)}.${s}`:`${l}.${s}`}}catch{}return `${r}.${s}`}async function v(e,{filename:n,convertMime:t}){let o=await q(e.src);if(f(o))throw `[downloadImageFromNetwork] failed to fetch ${e.src}`;let{blob:r,mime:a}=o;m(t)&&a!==t&&(r=await Y(r,t),a=t);let i=w({overrideName:n,url:e.src,...a&&{mime:a},defaultExt:"img",defaultBase:"image"});p(r,i);}async function X(e,n,t){let o=K(e);if(f(o))throw `[downloadImageFromCanvas] Failed to draw image to canvas (${n.src})`;return k(o,n,t)}async function k(e,n,{filename:t,convertMime:o}){try{let r=await H(e,o??n.extension),a=r.type||o||n.extension||"image/png",i=w({overrideName:t,url:n.src,mime:a,defaultExt:o?U(o)||"img":"png",defaultBase:"image"});p(r,i);}catch(r){let a="[downloadImageFromCanvas] canvas export failed (possibly due to CORS)";throw console.warn(a,r),a}}async function B(e,n){let t=$(new Image);t.src=e;try{return await V(t,n),t}catch(o){console.warn(`Failed to load image ${e}`,o);}}function $(e){return e.crossOrigin="anonymous",e.loading="eager",e.referrerPolicy="no-referrer",e}function p(e,n){let t=URL.createObjectURL(e),o=document.createElement("a");o.href=t,o.download=n||"download",document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(t);}function K(e){let n=document.createElement("canvas");n.width=e.naturalWidth,n.height=e.naturalHeight;let t=n.getContext("2d");if(t)return t.drawImage(e,0,0),n}function H(e,n){return new Promise((t,o)=>{try{e.toBlob(r=>m(r)?t(r):o(new Error("Canvas toBlob returned null")),n||void 0);}catch(r){o(r);}})}async function Y(e,n){if(!n)return e;try{let t=document.createElement("canvas"),o=!1;if(typeof createImageBitmap=="function"){let a=await createImageBitmap(e);t.width=a.width,t.height=a.height;let i=t.getContext("2d");i&&(i.drawImage(a,0,0),o=!0),typeof a.close=="function"&&a.close();}if(!o){let a=document.createElement("img"),i=URL.createObjectURL(e);await new Promise((c,l)=>{a.onload=c,a.onerror=l,a.src=i;}),t.width=a.naturalWidth,t.height=a.naturalHeight;let s=t.getContext("2d");if(!s)return e;s.drawImage(a,0,0),URL.revokeObjectURL(i);}return await H(t,n)||e}catch{return e}}async function q(e){let n;try{n=await fetch(e);}catch(i){console.warn("downloadImage: network error while fetching image:",i);return}if(!n.ok){console.warn("downloadImage: network error, status "+n.status+" while fetching image");return}let t=n.headers.get("Content-Type")||"",o=t.split(";")[0]?.trim().toLowerCase();if(o&&!o.startsWith("image/")){console.warn("downloadImage: fetched resource is not an image. Content-Type:",t);return}let r=await n.blob(),a=o&&o.startsWith("image/")?o:r.type&&r.type.startsWith("image/")?r.type:void 0;if(!a||!a.startsWith("image/")){console.warn("downloadImage: fetched data is not an image (no usable image MIME type).");return}return {blob:r,mime:a}}function J(e){return /\.(gif|apng|webp|avif)(?=($|[?#]))/i.test(e)}function Q(e){try{let n=new URL(e,window.location.href),t=n.searchParams;for(let r of x){let a=t.get(r);if(a&&u.includes(a.toLowerCase()))return !0}let o=n.search.toLowerCase();return u.some(r=>o.includes(`format=${r}`)||o.includes(`fm=${r}`))}catch{return /(format|fm)=\s*(webp|gif|apng|avif)/i.test(e)}}async function h(e,n){let t=A(n,e);if(e instanceof HTMLImageElement)return D(e,t);if(typeof e=="string")return L(e,t);if(e instanceof HTMLCanvasElement)return S(e,t);if(C(e))return O(e,t);console.warn("downloadImage: Unsupported input type",e);}async function z(e,n={}){let{batchSize:t=5,delayMS:o=500,...r}=n??{};return e instanceof NodeList&&(e=Array.from(e)),y(e,a=>{let[i,s]=Array.isArray(a)?a:[a,void 0],c=P(s,r);return h(i,c)},{batchSize:t,delayMS:o})}window.downloadImage=h;window.downloadImages=z;